const sigUtil = require('eth-sig-util')
const priv2addr = require('ethereum-private-key-to-address')
const mushie = require('../index');
(async () => {
  const maker = await mushie.maker()
  const alice = await maker.make({
    key: "m'/44'/60'/0'/0/0",
    use: {
      ethereum: (key) => {
        return {
          verify: (data, sig) => {
            //return sigUtil.recoverTypedSignature_v4({ data, sig });
            return sigUtil.recoverPersonalSignature({ data, sig });
          },
          request: async (o) => {
            if (o.method === "eth_signTypedData_v4") {
              return sigUtil.signTypedData_v4(key.privateKey, { data: JSON.parse(o.params[1]) });
            } else if (o.method === "personal_sign") {
              return sigUtil.personalSign(key.privateKey, { data: o.params[1] });
            } else if (o.method === "eth_requestAccounts") {
              console.log("privateKey = ", key.privateKey)
              return [priv2addr(key.privateKey)]
            }
          }
        }
      },
    }
  })
  let sig = await alice.ethereum.request({
    method: "personal_sign",
    params: [null, "hello world"]
  })
  console.log("sig = ", sig)
  let valid
  try {
    valid = alice.ethereum.verify("hello world", sig+"x")
  } catch (e) {
    valid = false  
  }
  console.log("valid", valid)
})();
